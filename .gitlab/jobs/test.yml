# -----------------------
# ðŸ§ª Test Stage
# -----------------------
Run Tests:
  stage: test
  image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
  cache:
    key: "${CI_COMMIT_REF_SLUG}-uv-test"
    paths:
      - .venv/
  before_script:
    - echo "Installing dependencies with uv..."
    - uv sync --group dev
    - uv pip install -e .
    # - export PYTHONPATH="${CI_PROJECT_DIR}/src:${PYTHONPATH}"
  script:
    - echo "Running all tests with coverage..."
    - uv run pytest tests/ -v 
        --cov=src 
        --cov-report=term-missing
        --cov-report=html:reports/coverage/html
        --cov-report=xml:reports/coverage/coverage.xml
        --cov-fail-under=10
        --tb=short
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: reports/coverage/coverage.xml
    paths:
      - reports/coverage/
    expire_in: 30 days
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  rules:
    # Always run on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    # Always run on push
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: always
    # Manual option
    - when: manual
      allow_failure: true

Run Unit Tests Only:
  stage: test
  image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
  cache:
    key: "${CI_COMMIT_REF_SLUG}-uv-test"
    paths:
      - .venv/
  before_script:
    - echo "Installing dependencies with uv..."
    - uv sync --group dev
    - uv pip install -e .
    # - export PYTHONPATH="${CI_PROJECT_DIR}/src:${PYTHONPATH}"
  script:
    - echo "Running unit tests only..."
    - uv run pytest tests/unit/ -v --tb=short
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
  allow_failure: true

Run Integration Tests Only:
  stage: test
  image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
  cache:
    key: "${CI_COMMIT_REF_SLUG}-uv-test"
    paths:
      - .venv/
  before_script:
    - echo "Installing dependencies with uv..."
    - uv sync --group dev
    - uv pip install -e .
    # - export PYTHONPATH="${CI_PROJECT_DIR}/src:${PYTHONPATH}"
  script:
    - echo "Running integration tests only..."
    - uv run pytest tests/integration/ -v --tb=short
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
  allow_failure: true
