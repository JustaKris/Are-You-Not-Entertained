# -----------------------
# ðŸ”’ Security Scan Stage
# -----------------------
# Note: Security scan waits for type-check to complete, then runs in parallel with tests
# This allows fast feedback while still ensuring code quality checks pass first
Security Scan:
  stage: security
  needs: ["Type Check"]  # Wait for type-check; runs parallel with tests to provide fast feedback
  image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
  cache:
    key: "${CI_COMMIT_REF_SLUG}-uv-security"
    paths:
      - .venv/
  before_script:
    - echo "Installing dependencies with uv..."
    - uv sync --group dev
  script:
    - echo "Running bandit security scan (code vulnerabilities)..."
    - |
      uv run bandit -r src/ -f json -o bandit-report.json \
        --skip B104,B108 || true
      uv run bandit -r src/ --skip B104,B108
    
    - echo "Checking for known vulnerabilities with pip-audit..."
    - uv run pip-audit --desc --skip-editable || true
    
  artifacts:
    when: always
    paths:
      - bandit-report.json
    expire_in: 30 days
    reports:
      # GitLab security report format
      sast: bandit-report.json
  allow_failure: true
  rules:
    # Run on merge requests when Python files change
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "src/**/*"
        - "pyproject.toml"
      when: always
    # Run on push to main when Python files change
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      changes:
        - "src/**/*"
        - "pyproject.toml"
      when: always
    # Weekly scheduled scans
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    # Manual option
    - when: manual
      allow_failure: true