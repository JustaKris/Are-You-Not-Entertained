# ----------------------------------------
# üìö Documentation Deployment Job
# ----------------------------------------
# Builds and deploys MkDocs documentation to GitLab Pages
# Runs on: main branch pushes, MR events, manual workflow dispatch
# Note: Job MUST be named 'pages' for GitLab Pages deployment

pages:
  stage: deploy
  image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
  
  cache:
    key: "${CI_COMMIT_REF_SLUG}-uv-docs"
    paths:
      - .venv/
  
  before_script:
    - echo "Installing documentation dependencies with uv..."
    - uv sync --group docs
  
  script:
    - echo "Building MkDocs documentation..."
    - uv run mkdocs build -d public
    - echo "Documentation built successfully"
    - ls -la public/
  
  after_script:
    - |
      if [ $CI_JOB_STATUS == 'success' ]; then
        echo -e "\033[1;32m‚úÖ Documentation deployed successfully!\033[0m"
        echo -e "\033[1;36mView at: https://${CI_PROJECT_NAMESPACE}.gitlab.io/${CI_PROJECT_NAME}/\033[0m"
      else
        echo -e "\033[1;31m‚ùå Documentation deployment failed. Please review the output above.\033[0m"
      fi
  
  artifacts:
    paths:
      - public
    expire_in: 30 days
    when: on_success
  
  # Ensure docs only deploy after passing tests
  # needs:
  #   - "Run Tests"  # Wait for test suite to pass before deploying
  
  rules:
    # Always run on merge requests to validate docs build
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    
    # Auto-deploy on push to main when docs files change
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      changes:
        - mkdocs.yml
        - docs/**/*
        - pyproject.toml
        - .gitlab/jobs/docs.yml
      when: always
    
    # Auto-deploy on any push to main (catches job config changes)
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      when: on_success
    
    # Manual trigger option for any branch
    - when: manual
      allow_failure: true
